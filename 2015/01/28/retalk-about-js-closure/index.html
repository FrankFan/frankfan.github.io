<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 再谈js闭包 · Frank Fan's Blog</title><meta name="description" content="再谈js闭包 - Frank Fan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://fy98.com/atom.xml" title="Frank Fan's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">再谈js闭包</h1><div class="post-info">2015年1月28日</div><div class="post-content"><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fsbzp7nw1zj306g04zmx7.jpg" alt=""></p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>一谈到js闭包就不能不说js作用域、作用域链。我们知道，一个函数中嵌套另一个函数时，内部函数由于作用域链的存在，很容易访问外部函数的变量。可是，外部函数就没办法访问内部函数的变量。<br>一句话定义闭包：当函数a内部的函数b被函数a外的一个变量引用的时候，就创建了一个闭包。即：外部函数引用内部函数的变量。</p>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><blockquote>
<ul>
<li>（1）可以读取函数内部的变量</li>
<li>（2）让这些变量的值是中保持在内存中</li>
</ul>
</blockquote>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>如果过多的使用闭包而不释放掉这些引用，就会导致内存中的变量越来越多，进而影响性能。<br>在Javascript中，如果一个对象不再被引用，那么这个对象就会被GC回收。如果两个对象互相引用，而不再被第三者所引用，那么这两个互相引用的对象也会被回收。因为函数a被函数b引用，b又被a外的函数引用，这就是为什么函数a执行后不会被回收的原因。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>第一题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = functioin() &#123;</span><br><span class="line">     <span class="comment">// 变量作用域为函数内部，所以外部函数通过普通方式无法访问</span></span><br><span class="line">     <span class="keyword">var</span> name = <span class="string">'default'</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> &#123;</span><br><span class="line">          getName: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> name;&#125;,</span><br><span class="line">          setName: <span class="function"><span class="keyword">function</span>(<span class="params">newName</span>) </span>&#123; name = newName;&#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试代码</span></span><br><span class="line"><span class="built_in">console</span>.log(person.name); <span class="comment">// undefined</span></span><br><span class="line"><span class="built_in">console</span>.log(person.getName()); <span class="comment">// default</span></span><br><span class="line"><span class="built_in">console</span>.log(person.setName(<span class="string">'fy98.com'</span>)); <span class="comment">// 设值</span></span><br><span class="line"><span class="built_in">console</span>.log(person.getName()); <span class="comment">// fy98.com</span></span><br></pre></td></tr></table></figure>
<p>第二题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设 HTML 中有 5 个 name='btn' 的 button</span></span><br><span class="line"><span class="comment">// 需求是当点击按钮的时候弹出当前btn的顺序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buttons =<span class="built_in">document</span>.getElementsByName(<span class="string">'btn'</span>);</span><br><span class="line"><span class="keyword">var</span> len = buttons.length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">     <span class="keyword">var</span> button = buttons[i];</span><br><span class="line">     button.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(i); </span><br><span class="line">     &#125;, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上述代码的结果是： 不论点击哪个按钮，控制台打印出来的都是5， 表明`i`的值都是一样的</span></span><br><span class="line"><span class="comment">// 这显然不是我们想要的结果，怎么解决呢？ 可以使用闭包改造一下，让外面的函数访问内部函数的变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用闭包改造</span></span><br><span class="line"><span class="keyword">var</span> buttons = <span class="built_in">document</span>.getElementsByName(<span class="string">'btn'</span>);</span><br><span class="line"><span class="keyword">var</span> len = buttons.length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">     <span class="keyword">var</span> button = buttons[i];</span><br><span class="line">     button.addEventListener(<span class="string">'click'</span>, (<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">               <span class="built_in">console</span>.log(i); </span><br><span class="line">          &#125;</span><br><span class="line">     &#125;)(i), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来一道：<code>不恰当使用闭包容易引起内存泄露</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function foo() &#123;</span><br><span class="line">     var oDiv = document.getElementById(&apos;div&apos;);</span><br><span class="line">     var id = oDiv.id; // here</span><br><span class="line">     oDiv.onclick = function() &#123;</span><br><span class="line">          // alert(oDiv.id); </span><br><span class="line">          // 这里存在循环引用, IE低版本在页面关闭后oDiv仍在内存中，</span><br><span class="line">          // 所以尽可能缓存基本类型，而不是对象</span><br><span class="line">          alert(id);</span><br><span class="line">     &#125;;</span><br><span class="line">     // 手动讲对象指向null</span><br><span class="line">     oDiv = null; // here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2015/02/02/css-core-but-basic-concepts/" class="prev">上一篇</a><a href="/2015/01/22/this-in-javascript/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2018 <a href="http://fy98.com">Frank Fan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>